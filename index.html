<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro Empresarial - Google Sheets</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and React DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #2563eb;
            color: white;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { TrendingUp, TrendingDown, DollarSign, Calendar, Plus, RefreshCw, BarChart3, PieChart, Settings } = lucide;

        const FinancialDashboard = () => {
            const [realizadoData, setRealizadoData] = useState([]);
            const [previstoData, setPrevistoData] = useState([]);
            const [planoContasData, setPlanoContasData] = useState([]);
            const [drfData, setDrfData] = useState([]);
            const [summary, setSummary] = useState({ 
                realizadoReceitas: 0, 
                realizadoDespesas: 0, 
                previstoReceitas: 0, 
                previstoDespesas: 0,
                balanceRealizado: 0,
                balancePrevisto: 0
            });
            const [loading, setLoading] = useState(false);
            const [activeTab, setActiveTab] = useState('realizado');
            const [selectedMonth, setSelectedMonth] = useState('');

            // ✅ CONFIGURAÇÕES PRONTAS
            const SHEET_ID = '1prVtG6HsY9Ju0AxEzd7tZrLWO4ZBb_zk8rA23FCYsOg';
            const API_KEY = 'AIzaSyDurbBtD-9CaAzU-hfnjeLUhJdFUQ05egU';
            
            // Ranges das abas (cabeçalhos nas linhas especificadas)
            const RANGES = {
                realizado: 'Realizado!A4:O',  // Linha 4 em diante
                previsto: 'Previsto!A4:O',    // Linha 4 em diante
                planoContas: 'Plano de Contas!A1:E', // Linha 1 em diante
                drf: 'DRF!A1:C' // Linha 1 em diante
            };

            // Função para buscar dados de uma aba específica
            const fetchSheetData = async (range) => {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`
                );
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                return data.values || [];
            };

            // Função principal para buscar todos os dados
            const fetchAllData = async () => {
                setLoading(true);
                try {
                    const [realizadoRaw, previstoRaw, planoContasRaw, drfRaw] = await Promise.all([
                        fetchSheetData(RANGES.realizado),
                        fetchSheetData(RANGES.previsto),
                        fetchSheetData(RANGES.planoContas),
                        fetchSheetData(RANGES.drf)
                    ]);

                    // Processar dados do Realizado
                    if (realizadoRaw.length > 0) {
                        const realizadoHeaders = realizadoRaw[0];
                        const realizadoProcessed = realizadoRaw.slice(1).map((row, index) => ({
                            id: index + 1,
                            indice: row[0] || '',
                            cnpj: row[1] || '',
                            banco: row[2] || '',
                            data: row[3] || '',
                            mes: row[4] || '',
                            descricao: row[5] || '',
                            valor: parseFloat(row[6]?.toString().replace(/[^\d.-]/g, '')) || 0,
                            idContaN1: row[7] || '',
                            kpi: row[8] || '',
                            categoria: row[9] || '',
                            idConta: row[10] || '',
                            subCategoria: row[11] || '',
                            observacao: row[12] || '',
                            nfEmitida: row[13] || '',
                            pago: row[14] || ''
                        })).filter(t => t.valor !== 0 && t.descricao);
                        
                        setRealizadoData(realizadoProcessed);
                    }

                    // Processar dados do Previsto
                    if (previstoRaw.length > 0) {
                        const previstoProcessed = previstoRaw.slice(1).map((row, index) => ({
                            id: index + 1,
                            indice: row[0] || '',
                            cnpj: row[1] || '',
                            banco: row[2] || '',
                            data: row[3] || '',
                            mes: row[4] || '',
                            descricao: row[5] || '',
                            valor: parseFloat(row[6]?.toString().replace(/[^\d.-]/g, '')) || 0,
                            idContaN1: row[7] || '',
                            kpi: row[8] || '',
                            categoria: row[9] || '',
                            idConta: row[10] || '',
                            subCategoria: row[11] || '',
                            observacao: row[12] || '',
                            formaPagamento: row[13] || '',
                            status: row[14] || ''
                        })).filter(t => t.valor !== 0 && t.descricao);
                        
                        setPrevistoData(previstoProcessed);
                    }

                    // Processar Plano de Contas
                    if (planoContasRaw.length > 0) {
                        const planoContasProcessed = planoContasRaw.slice(1).map((row, index) => ({
                            id: index + 1,
                            idConta: row[0] || '',
                            subCategoria: row[1] || '',
                            idContaN2: row[2] || '',
                            categoria: row[3] || '',
                            idContaN1: row[4] || ''
                        }));
                        
                        setPlanoContasData(planoContasProcessed);
                    }

                    // Processar DRF
                    if (drfRaw.length > 0) {
                        const drfProcessed = drfRaw.slice(1).map((row, index) => ({
                            id: index + 1,
                            idContaN1: row[0] || '',
                            contaSuperior: row[1] || '',
                            subtotal: parseFloat(row[2]?.toString().replace(/[^\d.-]/g, '')) || 0
                        }));
                        
                        setDrfData(drfProcessed);
                    }

                    // Calcular resumos
                    calculateSummary(realizadoRaw.slice(1), previstoRaw.slice(1));

                } catch (error) {
                    console.error('Erro detalhado:', error);
                    alert(`Erro ao carregar dados da planilha:\n${error.message}\n\nVerifique se a planilha está acessível com o link compartilhado.`);
                } finally {
                    setLoading(false);
                }
            };

            // Calcular resumos financeiros
            const calculateSummary = (realizadoRaw, previstoRaw) => {
                // Realizado
                const realizadoReceitas = realizadoRaw
                    .filter(row => parseFloat(row[6]) > 0)
                    .reduce((sum, row) => sum + (parseFloat(row[6]?.toString().replace(/[^\d.-]/g, '')) || 0), 0);
                
                const realizadoDespesas = Math.abs(realizadoRaw
                    .filter(row => parseFloat(row[6]) < 0)
                    .reduce((sum, row) => sum + (parseFloat(row[6]?.toString().replace(/[^\d.-]/g, '')) || 0), 0));

                // Previsto
                const previstoReceitas = previstoRaw
                    .filter(row => parseFloat(row[6]) > 0)
                    .reduce((sum, row) => sum + (parseFloat(row[6]?.toString().replace(/[^\d.-]/g, '')) || 0), 0);
                
                const previstoDespesas = Math.abs(previstoRaw
                    .filter(row => parseFloat(row[6]) < 0)
                    .reduce((sum, row) => sum + (parseFloat(row[6]?.toString().replace(/[^\d.-]/g, '')) || 0), 0));

                setSummary({
                    realizadoReceitas,
                    realizadoDespesas,
                    previstoReceitas,
                    previstoDespesas,
                    balanceRealizado: realizadoReceitas - realizadoDespesas,
                    balancePrevisto: previstoReceitas - previstoDespesas
                });
            };

            // Filtrar dados por mês
            const getFilteredData = (data) => {
                if (!selectedMonth) return data;
                return data.filter(item => item.mes === selectedMonth || item.data?.includes(selectedMonth));
            };

            // Carregar dados ao montar o componente
            useEffect(() => {
                fetchAllData();
            }, []);

            const formatCurrency = (value) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(Math.abs(value));
            };

            const formatDate = (dateString) => {
                try {
                    if (dateString.includes('/')) {
                        return dateString;
                    }
                    return new Date(dateString).toLocaleDateString('pt-BR');
                } catch {
                    return dateString;
                }
            };

            // Obter meses únicos dos dados
            const getUniqueMonths = () => {
                const months = [...realizadoData, ...previstoData]
                    .map(item => item.mes)
                    .filter(mes => mes && mes.trim() !== '');
                return [...new Set(months)].sort();
            };

            const renderTransactionList = (data, title) => {
                const filteredData = getFilteredData(data);
                
                return React.createElement('div', {
                    className: "bg-white rounded-xl shadow-lg p-6"
                },
                    React.createElement('h3', {
                        className: "text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2"
                    },
                        React.createElement(Calendar, { className: "w-5 h-5" }),
                        `${title} (${filteredData.length})`
                    ),
                    
                    React.createElement('div', {
                        className: "space-y-3 max-h-96 overflow-y-auto"
                    },
                        filteredData.length === 0 ?
                            React.createElement('div', {
                                className: "text-center py-8 text-gray-500"
                            },
                                React.createElement('p', {}, "Nenhum dado encontrado"),
                                React.createElement('p', {
                                    className: "text-sm mt-2"
                                }, selectedMonth ? "Tente selecionar outro mês" : "Verifique a configuração da planilha")
                            ) :
                            filteredData.slice(0, 15).map((item) =>
                                React.createElement('div', {
                                    key: item.id,
                                    className: "flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                                },
                                    React.createElement('div', {
                                        className: "flex-1 min-w-0"
                                    },
                                        React.createElement('p', {
                                            className: "font-medium text-gray-800 truncate"
                                        }, item.descricao),
                                        React.createElement('div', {
                                            className: "flex items-center gap-2 text-sm text-gray-600 mt-1"
                                        },
                                            React.createElement('span', {}, formatDate(item.data)),
                                            React.createElement('span', {}, "•"),
                                            React.createElement('span', {
                                                className: "bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs"
                                            }, item.categoria || 'Sem categoria'),
                                            item.mes && React.createElement('span', {}, "•"),
                                            item.mes && React.createElement('span', {
                                                className: "bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs"
                                            }, item.mes)
                                        )
                                    ),
                                    React.createElement('div', {
                                        className: "text-right ml-4"
                                    },
                                        React.createElement('p', {
                                            className: `font-bold ${item.valor >= 0 ? 'text-green-600' : 'text-red-600'}`
                                        }, 
                                            (item.valor >= 0 ? '+' : '') + formatCurrency(item.valor)
                                        ),
                                        item.banco && React.createElement('p', {
                                            className: "text-xs text-gray-500 mt-1"
                                        }, item.banco)
                                    )
                                )
                            )
                    )
                );
            };

            return React.createElement('div', {
                className: "min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4"
            }, 
                React.createElement('div', {
                    className: "max-w-7xl mx-auto space-y-6"
                },
                    
                    // Header
                    React.createElement('div', {
                        className: "text-center py-8"
                    },
                        React.createElement('h1', {
                            className: "text-4xl font-bold text-gray-800 mb-2"
                        }, "Dashboard Financeiro Empresarial"),
                        React.createElement('p', {
                            className: "text-gray-600"
                        }, "Análise de Dados Realizado vs Previsto"),
                        
                        // Controles
                        React.createElement('div', {
                            className: "flex flex-col sm:flex-row items-center justify-center gap-4 mt-6"
                        },
                            React.createElement('button', {
                                onClick: fetchAllData,
                                disabled: loading,
                                className: "bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
                            },
                                React.createElement(RefreshCw, {
                                    className: `w-4 h-4 ${loading ? 'loading-spinner' : ''}`
                                }),
                                "Atualizar Dados"
                            ),
                            
                            // Filtro por mês
                            React.createElement('select', {
                                value: selectedMonth,
                                onChange: (e) => setSelectedMonth(e.target.value),
                                className: "px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                            },
                                React.createElement('option', { value: "" }, "Todos os meses"),
                                getUniqueMonths().map(month => 
                                    React.createElement('option', { key: month, value: month }, month)
                                )
                            )
                        )
                    ),

                    // Cards de Resumo Comparativo
                    React.createElement('div', {
                        className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"
                    },
                        // Realizado - Receitas
                        React.createElement('div', {
                            className: "bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500"
                        },
                            React.createElement('div', {
                                className: "flex items-center justify-between"
                            },
                                React.createElement('div', {},
                                    React.createElement('p', {
                                        className: "text-gray-600 text-sm font-medium"
                                    }, "Receitas Realizadas"),
                                    React.createElement('p', {
                                        className: "text-xl font-bold text-green-600"
                                    }, formatCurrency(summary.realizadoReceitas))
                                ),
                                React.createElement(TrendingUp, {
                                    className: "w-6 h-6 text-green-500"
                                })
                            )
                        ),

                        // Realizado - Despesas
                        React.createElement('div', {
                            className: "bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500"
                        },
                            React.createElement('div', {
                                className: "flex items-center justify-between"
                            },
                                React.createElement('div', {},
                                    React.createElement('p', {
                                        className: "text-gray-600 text-sm font-medium"
                                    }, "Despesas Realizadas"),
                                    React.createElement('p', {
                                        className: "text-xl font-bold text-red-600"
                                    }, formatCurrency(summary.realizadoDespesas))
                                ),
                                React.createElement(TrendingDown, {
                                    className: "w-6 h-6 text-red-500"
                                })
                            )
                        ),

                        // Previsto - Receitas
                        React.createElement('div', {
                            className: "bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500"
                        },
                            React.createElement('div', {
                                className: "flex items-center justify-between"
                            },
                                React.createElement('div', {},
                                    React.createElement('p', {
                                        className: "text-gray-600 text-sm font-medium"
                                    }, "Receitas Previstas"),
                                    React.createElement('p', {
                                        className: "text-xl font-bold text-blue-600"
                                    }, formatCurrency(summary.previstoReceitas))
                                ),
                                React.createElement(BarChart3, {
                                    className: "w-6 h-6 text-blue-500"
                                })
                            )
                        ),

                        // Previsto - Despesas
                        React.createElement('div', {
                            className: "bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-500"
                        },
                            React.createElement('div', {
                                className: "flex items-center justify-between"
                            },
                                React.createElement('div', {},
                                    React.createElement('p', {
                                        className: "text-gray-600 text-sm font-medium"
                                    }, "Despesas Previstas"),
                                    React.createElement('p', {
                                        className: "text-xl font-bold text-orange-600"
                                    }, formatCurrency(summary.previstoDespesas))
                                ),
                                React.createElement(PieChart, {
                                    className: "w-6 h-6 text-orange-500"
                                })
                            )
                        )
                    ),

                    // Saldos
                    React.createElement('div', {
                        className: "grid grid-cols-1 md:grid-cols-2 gap-6"
                    },
                        React.createElement('div', {
                            className: "bg-white rounded-xl shadow-lg p-6 text-center"
                        },
                            React.createElement('h3', {
                                className: "text-lg font-semibold text-gray-800 mb-2"
                            }, "Saldo Realizado"),
                            React.createElement('p', {
                                className: `text-3xl font-bold ${summary.balanceRealizado >= 0 ? 'text-green-600' : 'text-red-600'}`
                            }, formatCurrency(summary.balanceRealizado))
                        ),
                        
                        React.createElement('div', {
                            className: "bg-white rounded-xl shadow-lg p-6 text-center"
                        },
                            React.createElement('h3', {
                                className: "text-lg font-semibold text-gray-800 mb-2"
                            }, "Saldo Previsto"),
                            React.createElement('p', {
                                className: `text-3xl font-bold ${summary.balancePrevisto >= 0 ? 'text-blue-600' : 'text-orange-600'}`
                            }, formatCurrency(summary.balancePrevisto))
                        )
                    ),

                    // Tabs
                    React.createElement('div', {
                        className: "bg-white rounded-xl shadow-lg overflow-hidden"
                    },
                        React.createElement('div', {
                            className: "flex border-b border-gray-200"
                        },
                            ['realizado', 'previsto', 'planoContas', 'drf'].map(tab => 
                                React.createElement('button', {
                                    key: tab,
                                    onClick: () => setActiveTab(tab),
                                    className: `tab-button px-6 py-3 font-medium text-sm ${activeTab === tab ? 'active' : 'text-gray-600 hover:text-gray-800'}`
                                }, 
                                    tab === 'realizado' ? 'Realizado' :
                                    tab === 'previsto' ? 'Previsto' :
                                    tab === 'planoContas' ? 'Plano de Contas' :
                                    'DRF'
                                )
                            )
                        ),
                        
                        React.createElement('div', {
                            className: "p-6"
                        },
                            loading ? 
                                React.createElement('div', {
                                    className: "text-center py-12"
                                },
                                    React.createElement('div', {
                                        className: "loading-spinner rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"
                                    }),
                                    React.createElement('p', {
                                        className: "text-gray-600 mt-4"
                                    }, "Carregando dados...")
                                ) :
                                activeTab === 'realizado' ? renderTransactionList(realizadoData, 'Transações Realizadas') :
                                activeTab === 'previsto' ? renderTransactionList(previstoData, 'Transações Previstas') :
                                activeTab === 'planoContas' ? 
                                    React.createElement('div', {
                                        className: "space-y-3"
                                    },
                                        React.createElement('h3', {
                                            className: "text-lg font-semibold mb-4"
                                        }, `Plano de Contas (${planoContasData.length} itens)`),
                                        React.createElement('div', {
                                            className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto"
                                        },
                                            planoContasData.map(conta =>
                                                React.createElement('div', {
                                                    key: conta.id,
                                                    className: "bg-gray-50 p-4 rounded-lg"
                                                },
                                                    React.createElement('p', {
                                                        className: "font-semibold text-gray-800"
                                                    }, conta.categoria),
                                                    React.createElement('p', {
                                                        className: "text-sm text-gray-600"
                                                    }, conta.subCategoria),
                                                    React.createElement('p', {
                                                        className: "text-xs text-gray-500 mt-1"
                                                    }, `ID: ${conta.idConta}`)
                                                )
                                            )
                                        )
                                    ) :
                                    React.createElement('div', {
                                        className: "space-y-3"
                                    },
                                        React.createElement('h3', {
                                            className: "text-lg font-semibold mb-4"
                                        }, `DRF - Demonstração de Resultados (${drfData.length} itens)`),
                                        React.createElement('div', {
                                            className: "space-y-2 max-h-96 overflow-y-auto"
                                        },
                                            drfData.map(drf =>
                                                React.createElement('div', {
                                                    key: drf.id,
                                                    className: "flex justify-between items-center bg-gray-50 p-4 rounded-lg"
                                                },
                                                    React.createElement('div', {},
                                                        React.createElement('p', {
                                                            className: "font-medium text-gray-800"
                                                        }, drf.contaSuperior),
                                                        React.createElement('p', {
                                                            className: "text-sm text-gray-600"
                                                        }, `ID: ${drf.idContaN1}`)
                                                    ),
                                                    React.createElement('p', {
                                                        className: `font-bold ${drf.subtotal >= 0 ? 'text-green-600' : 'text-red-600'}`
                                                    }, formatCurrency(drf.subtotal))
                                                )
                                            )
                                        )
                                    )
                        )
                    ),

                    // Status da Conexão
                    React.createElement('div', {
                        className: "bg-green-50 border border-green-200 rounded-xl p-6"
                    },
                        React.createElement('h3', {
                            className: "text-lg font-semibold text-green-800 mb-2"
                        }, "✅ Dashboard Configurado"),
                        React.createElement('div', {
                            className: "text-sm text-green-700 space-y-1"
                        },
                            React.createElement('p', {}, `📊 Dados Realizados: ${realizadoData.length} registros`),
                            React.createElement('p', {}, `📈 Dados Previstos: ${previstoData.length} registros`),
                            React.createElement('p', {}, `🏦 Plano de Contas: ${planoContasData.length} contas`),
                            React.createElement('p', {}, `📋 DRF: ${drfData.length} itens`),
                            React.createElement('p', { className: "mt-2 text-xs" }, `Planilha: ${SHEET_ID}`)
                        )
                    )
                )
            );
        };

        // Renderizar o componente
        ReactDOM.render(React.createElement(FinancialDashboard), document.getElementById('root'));
    </script>
</body>
</html>
